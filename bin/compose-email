#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = ["jinja2", "typer"]
# ///
"""Compose and send emails with template substitution support."""

import os
import re
import subprocess
import sys
import tempfile
import time
from email.message import EmailMessage
from email.utils import formatdate, make_msgid
from enum import Enum
from pathlib import Path
from socket import gethostname
from typing import Annotated, Optional

import typer
from jinja2 import Environment, StrictUndefined


class Account(str, Enum):
    personal = "personal"
    anu = "anu"
    phd = "phd"
    phdconvenor = "phdconvenor"


class AccountConfig:
    def __init__(
        self,
        from_addr: str,
        msmtp: str,
        maildir: Path,
        sent_folder: str,
        neomutt_config: Path,
    ):
        self.from_addr = from_addr
        self.msmtp = msmtp
        self.maildir = maildir
        self.sent_folder = sent_folder
        self.neomutt_config = neomutt_config


ACCOUNT_CONFIG: dict[Account, AccountConfig] = {
    Account.personal: AccountConfig(
        from_addr="Ben Swift <ben@benswift.me>",
        msmtp="personal",
        maildir=Path.home() / "Maildir/personal",
        sent_folder="Sent Items",
        neomutt_config=Path.home() / ".config/neomutt/accounts/personal",
    ),
    Account.anu: AccountConfig(
        from_addr="Ben Swift <ben.swift@anu.edu.au>",
        msmtp="anu",
        maildir=Path.home() / "Maildir/anu",
        sent_folder="Sent Items",
        neomutt_config=Path.home() / ".config/neomutt/accounts/anu",
    ),
    Account.phd: AccountConfig(
        from_addr="Ben Swift <phdconvenor.cybernetics@anu.edu.au>",
        msmtp="phdconvenor",
        maildir=Path.home() / "Maildir/phdconvenor",
        sent_folder="Sent Items",
        neomutt_config=Path.home() / ".config/neomutt/accounts/phdconvenor",
    ),
    Account.phdconvenor: AccountConfig(
        from_addr="Ben Swift <phdconvenor.cybernetics@anu.edu.au>",
        msmtp="phdconvenor",
        maildir=Path.home() / "Maildir/phdconvenor",
        sent_folder="Sent Items",
        neomutt_config=Path.home() / ".config/neomutt/accounts/phdconvenor",
    ),
}

app = typer.Typer(
    help="Compose and send emails with template substitution.",
    add_completion=False,
    no_args_is_help=True,
)


def parse_json_lenient(text: str) -> list[dict]:
    import json

    cleaned = re.sub(r",(\s*[}\]])", r"\1", text)
    result = json.loads(cleaned)
    if not isinstance(result, list):
        raise ValueError("JSON must be an array")
    return result


JINJA_ENV = Environment(undefined=StrictUndefined)
FRONTMATTER_PATTERN = re.compile(r"^---\s*\n.*?\n---\s*\n", re.DOTALL)


def strip_frontmatter(content: str) -> str:
    return FRONTMATTER_PATTERN.sub("", content)


def substitute_template(template: str, data: dict) -> str:
    return JINJA_ENV.from_string(template).render(data)


def combine_cc(cc: str | None, cc_all: str | None) -> str | None:
    parts = [addr for addr in (cc, cc_all) if addr]
    return ", ".join(parts) if parts else None


def filter_records(records: list[dict], filter_expr: str | None) -> list[dict]:
    if not filter_expr:
        return records

    results = []
    for record in records:
        try:
            if eval(filter_expr, {"__builtins__": {}}, record):
                results.append(record)
        except Exception:
            pass
    return results


def build_email(
    from_addr: str,
    to: str,
    subject: str,
    body: str,
    cc: str | None = None,
    attachments: list[Path] | None = None,
) -> EmailMessage:
    msg = EmailMessage()
    msg["From"] = from_addr
    msg["To"] = to
    msg["Subject"] = subject
    msg["Date"] = formatdate(localtime=True)
    msg["Message-ID"] = make_msgid()

    if cc:
        msg["Cc"] = cc

    msg.set_content(body)

    if attachments:
        for attachment in attachments:
            if attachment.exists():
                content = attachment.read_bytes()
                msg.add_attachment(
                    content,
                    maintype="application",
                    subtype="octet-stream",
                    filename=attachment.name,
                )

    return msg


def save_to_sent(msg: EmailMessage, account: Account) -> Path:
    config = ACCOUNT_CONFIG[account]
    sent_dir = config.maildir / config.sent_folder / "cur"
    sent_dir.mkdir(parents=True, exist_ok=True)

    timestamp = int(time.time())
    hostname = gethostname().split(".")[0]
    filename = f"{timestamp}.{os.getpid()}.{hostname}:2,S"
    filepath = sent_dir / filename

    filepath.write_bytes(msg.as_bytes())
    return filepath


def send_email(msg: EmailMessage, account: Account, dry_run: bool = False) -> bool:
    config = ACCOUNT_CONFIG[account]

    if dry_run:
        typer.echo(f"--- Would send via msmtp account '{config.msmtp}' ---")
        typer.echo(msg.as_string())
        typer.echo("---")
        return True

    result = subprocess.run(
        ["msmtpq", "-t", "-a", config.msmtp],
        input=msg.as_bytes(),
        capture_output=True,
    )

    if result.returncode == 0:
        save_to_sent(msg, account)
        return True
    else:
        typer.echo(f"Failed to send: {result.stderr.decode()}", err=True)
        return False


def open_neomutt_compose(
    account: Account,
    to: str,
    subject: str,
    body: str,
    cc: str | None = None,
    attachments: list[Path] | None = None,
) -> None:
    config = ACCOUNT_CONFIG[account]

    with tempfile.NamedTemporaryFile(
        mode="w", suffix=".eml", delete=False
    ) as draft_file:
        draft_file.write(f"To: {to}\n")
        if cc:
            draft_file.write(f"Cc: {cc}\n")
        draft_file.write(f"Subject: {subject}\n\n")
        draft_file.write(body)
        draft_path = Path(draft_file.name)

    cmd = ["neomutt", "-e", f"source {config.neomutt_config}", "-H", str(draft_path)]

    if attachments:
        for attachment in attachments:
            if attachment.exists():
                cmd.extend(["-a", str(attachment)])
        cmd.append("--")

    env = os.environ.copy()
    env["TERM"] = "xterm-direct"

    try:
        subprocess.run(cmd, env=env)
    finally:
        draft_path.unlink(missing_ok=True)


@app.command()
def main(
    account: Annotated[Account, typer.Option("--from", "-f", help="Account to send from")],
    to: Annotated[Optional[str], typer.Option(help="Recipient (supports {{field}} templates)")] = None,
    cc: Annotated[Optional[str], typer.Option("--cc", "-c", help="CC recipient (supports templates in batch mode)")] = None,
    cc_all: Annotated[Optional[str], typer.Option("--cc-all", help="CC recipient added to all emails")] = None,
    subject: Annotated[Optional[str], typer.Option("--subject", "-s", help="Subject line")] = None,
    body: Annotated[Optional[str], typer.Option("--body", "-b", help="Body text (or '-' for stdin)")] = None,
    template: Annotated[Optional[Path], typer.Option(help="Template file for body")] = None,
    attach: Annotated[Optional[list[Path]], typer.Option("--attach", "-a", help="Attachment")] = None,
    data: Annotated[Optional[Path], typer.Option(help="JSON file for batch mode")] = None,
    filter_expr: Annotated[Optional[str], typer.Option("--filter", help="Filter expression")] = None,
    send: Annotated[bool, typer.Option(help="Send directly without editor")] = False,
    dry_run: Annotated[bool, typer.Option(help="Preview without sending")] = False,
) -> None:
    """
    Compose and send emails with template substitution.

    Examples:

        # Interactive compose (opens neomutt)
        compose-email -f anu -t colleague@example.com -s "Hello" -b "Body"

        # Direct send
        compose-email -f anu -t colleague@example.com -s "Hello" -b "Body" --send

        # Batch with template
        compose-email -f phd --data students.json --to 'u{{id}}@anu.edu.au' \\
            --subject 'Hello {{preferred_name}}' --template body.md \\
            --filter 'status == "active"' --send

        # Batch with per-recipient CC and a fixed CC on all emails
        compose-email -f phd --data students.json --to 'u{{id}}@anu.edu.au' \\
            --cc '{{supervisor_email}}' --cc-all 'admin@example.com' \\
            --subject 'Update' --template body.md --send
    """
    config = ACCOUNT_CONFIG[account]

    email_body = ""
    if template:
        if not template.exists():
            typer.echo(f"Template file not found: {template}", err=True)
            raise typer.Exit(1)
        email_body = strip_frontmatter(template.read_text())
    elif body == "-":
        email_body = sys.stdin.read()
    elif body:
        email_body = body

    if data:
        if not data.exists():
            typer.echo(f"Data file not found: {data}", err=True)
            raise typer.Exit(1)

        try:
            records = parse_json_lenient(data.read_text())
        except ValueError as e:
            typer.echo(f"Invalid data file: {e}", err=True)
            raise typer.Exit(1)

        records = filter_records(records, filter_expr)
        if filter_expr:
            typer.echo(f"Filtered to {len(records)} record(s)", err=True)

        if not records:
            typer.echo("No records to process", err=True)
            raise typer.Exit(0)

        if not to:
            typer.echo("--to is required for batch mode", err=True)
            raise typer.Exit(1)

        if not subject:
            typer.echo("--subject is required for batch mode", err=True)
            raise typer.Exit(1)

        if not send and not dry_run:
            typer.echo("Batch mode requires --send or --dry-run", err=True)
            raise typer.Exit(1)

        sent, failed = 0, 0
        for i, record in enumerate(records, 1):
            email_to = substitute_template(to, record)
            email_subject = substitute_template(subject, record)
            email_content = substitute_template(email_body, record)
            templated_cc = substitute_template(cc, record) if cc else None
            email_cc = combine_cc(templated_cc, cc_all)

            msg = build_email(config.from_addr, email_to, email_subject, email_content, email_cc)

            if dry_run:
                typer.echo(f"=== Email {i}/{len(records)} ===")

            if send_email(msg, account, dry_run):
                sent += 1
                if not dry_run:
                    typer.echo(f"Sent {i}/{len(records)}: {email_to}", err=True)
            else:
                failed += 1

        if not dry_run:
            typer.echo(f"Sent: {sent}, Failed: {failed}", err=True)

    else:
        if not to:
            typer.echo("--to is required", err=True)
            raise typer.Exit(1)

        if send or dry_run:
            msg = build_email(
                config.from_addr,
                to,
                subject or "",
                email_body,
                combine_cc(cc, cc_all),
                attach,
            )

            if send_email(msg, account, dry_run):
                if not dry_run:
                    typer.echo(f"Sent to {to}", err=True)
            else:
                raise typer.Exit(1)
        else:
            open_neomutt_compose(account, to, subject or "", email_body, combine_cc(cc, cc_all), attach)


if __name__ == "__main__":
    app()
