#!/usr/bin/env bash

# aerc address book integration script
# Wraps notmuch to search addresses by email/name rather than message content

QUERY="$1"
CACHE_FILE="$HOME/.cache/aerc-addresses"

# Create cache directory if needed
mkdir -p "$(dirname "$CACHE_FILE")"

# Rebuild cache if older than 1 hour or missing
if [[ ! -f "$CACHE_FILE" ]] || [[ $(find "$CACHE_FILE" -mmin +60 2>/dev/null | wc -l) -gt 0 ]]; then
    # Background rebuild - extract all addresses and format for aerc
    notmuch address --deduplicate=address --output=sender --output=recipients "*" 2>/dev/null | \
    sed 's/^\([^<]*\)<\([^>]*\)>$/\2\t\1/; s/\t[ \t]*$/\t/; /^\t/d' > "$CACHE_FILE.tmp" && \
    mv "$CACHE_FILE.tmp" "$CACHE_FILE" &
fi

# Search cache for query (in both email and name fields)
if [[ -f "$CACHE_FILE" ]]; then
    grep -i "$QUERY" "$CACHE_FILE" | head -50
fi