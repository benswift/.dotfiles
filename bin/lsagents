#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = ["psutil", "rich"]
# ///

import os
import re
import select
import sys
import termios
import time
import tty
from datetime import datetime

import psutil
from rich.console import Console, Group
from rich.live import Live
from rich.style import Style
from rich.table import Table
from rich.text import Text

GRUVBOX = {
    "fg": Style(color="#3c3836"),
    "bg4": Style(color="#7c6f64"),
    "bg4_dim": Style(color="#7c6f64", dim=True),
    "orange": Style(color="#af3a03", bold=True),
    "blue": Style(color="#076678", bold=True),
    "purple": Style(color="#8f3f71", bold=True),
    "green": Style(color="#79740e"),
    "aqua": Style(color="#427b58"),
    "yellow": Style(color="#b57614"),
    "yellow_bold": Style(color="#b57614", bold=True),
    "red": Style(color="#9d0006", bold=True),
    "dim": Style(dim=True),
}

AGENT_STYLES = {
    "claude": GRUVBOX["orange"],
    "codex": GRUVBOX["blue"],
    "gemini": GRUVBOX["purple"],
}

STRAY_PATTERNS = [
    ("chrome-hl", r"chrome-headless-shell"),
    ("agent-browser", r"agent-browser/.*daemon"),
    ("chromedriver", r"chromedriver"),
    ("playwright", r"playwright.*run-server"),
]

HOME = os.path.expanduser("~")


def fmt_elapsed(create_time: float) -> str:
    elapsed = int(time.time() - create_time)
    if elapsed < 0:
        elapsed = 0
    days, remainder = divmod(elapsed, 86400)
    hours, remainder = divmod(remainder, 3600)
    mins = remainder // 60
    out = ""
    if days > 0:
        out += f"{days}d"
    if hours > 0:
        out += f"{hours}h"
    out += f"{mins}m"
    return out


def shorten_path(path: str) -> str:
    if path.startswith(HOME):
        return "~" + path[len(HOME):]
    return path


def cmd_basename(p: psutil.Process) -> str:
    try:
        cmdline = p.cmdline()
        if cmdline:
            return os.path.basename(cmdline[0])
    except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
        pass
    return ""


def get_agents() -> list[dict]:
    agents = []
    for p in psutil.process_iter(["pid"]):
        try:
            name = cmd_basename(p)
            if name in AGENT_STYLES:
                with p.oneshot():
                    agents.append({
                        "agent": name,
                        "pid": str(p.pid),
                        "cpu": f"{p.cpu_percent():.1f}",
                        "mem": f"{p.memory_percent():.1f}",
                        "elapsed": fmt_elapsed(p.create_time()),
                        "cwd": shorten_path(p.cwd()),
                    })
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            continue
    return agents


def get_strays() -> list[dict]:
    strays = []
    for p in psutil.process_iter(["pid", "ppid"]):
        try:
            cmdline = " ".join(p.cmdline())
            if not cmdline:
                continue
            for label, pattern in STRAY_PATTERNS:
                if re.search(pattern, cmdline):
                    with p.oneshot():
                        ppid = p.ppid()
                        strays.append({
                            "label": label,
                            "pid": str(p.pid),
                            "cpu": f"{p.cpu_percent():.1f}",
                            "mem": f"{p.memory_percent():.1f}",
                            "elapsed": fmt_elapsed(p.create_time()),
                            "status": "orphaned" if ppid == 1 else f"ppid={ppid}",
                        })
                    break
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            continue
    return strays


def get_servers() -> list[dict]:
    servers = []
    for p in psutil.process_iter(["pid"]):
        try:
            conns = p.net_connections(kind="tcp")
            ports = [c.laddr.port for c in conns if c.status == "LISTEN" and 3000 <= c.laddr.port <= 9999]
            if not ports:
                continue
            with p.oneshot():
                servers.append({
                    "cmd": (cmd_basename(p) or p.name())[:12],
                    "pid": str(p.pid),
                    "port": str(ports[0]),
                    "cpu": f"{p.cpu_percent():.1f}",
                    "mem": f"{p.memory_percent():.1f}",
                    "elapsed": fmt_elapsed(p.create_time()),
                    "cwd": shorten_path(p.cwd()),
                })
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            continue
    return servers


def build_display() -> Group:
    now = datetime.now().strftime("%H:%M:%S")
    header = Text()
    header.append("lsagents", style=Style(color="#3c3836", bold=True))
    header.append("  ")
    header.append(now, style=GRUVBOX["yellow"])
    header.append("\n")

    agents = get_agents()
    agent_table = Table(
        show_header=True,
        show_edge=False,
        show_lines=False,
        box=None,
        padding=(0, 1),
        header_style=GRUVBOX["bg4"],
    )
    agent_table.add_column("AGENT", min_width=8, style=GRUVBOX["fg"])
    agent_table.add_column("PID", justify="right", min_width=6, style=GRUVBOX["fg"])
    agent_table.add_column("%CPU", justify="right", min_width=5, style=GRUVBOX["fg"])
    agent_table.add_column("%MEM", justify="right", min_width=5, style=GRUVBOX["fg"])
    agent_table.add_column("ELAPSED", justify="right", min_width=9, style=GRUVBOX["fg"])
    agent_table.add_column("CWD", style=GRUVBOX["aqua"])

    for a in agents:
        style = AGENT_STYLES[a["agent"]]
        agent_table.add_row(
            Text(a["agent"], style=style),
            a["pid"], a["cpu"], a["mem"], a["elapsed"], a["cwd"],
        )
    if not agents:
        agent_table.add_row(
            Text("(no agents running)", style=GRUVBOX["dim"]),
            "", "", "", "", "",
        )

    strays = get_strays()
    stray_table = Table(
        show_header=True,
        show_edge=False,
        show_lines=False,
        box=None,
        padding=(0, 1),
        header_style=GRUVBOX["bg4"],
    )
    stray_table.add_column("STRAY", min_width=16, style=GRUVBOX["fg"])
    stray_table.add_column("PID", justify="right", min_width=6, style=GRUVBOX["fg"])
    stray_table.add_column("%CPU", justify="right", min_width=5, style=GRUVBOX["fg"])
    stray_table.add_column("%MEM", justify="right", min_width=5, style=GRUVBOX["fg"])
    stray_table.add_column("ELAPSED", justify="right", min_width=9, style=GRUVBOX["fg"])
    stray_table.add_column("STATUS", style=GRUVBOX["dim"])

    for s in strays:
        stray_table.add_row(
            Text(s["label"], style=GRUVBOX["yellow_bold"]),
            s["pid"], s["cpu"], s["mem"], s["elapsed"], s["status"],
        )
    if not strays:
        stray_table.add_row(
            Text("(no stray processes)", style=GRUVBOX["dim"]),
            "", "", "", "", "",
        )

    servers = get_servers()
    server_table = Table(
        show_header=True,
        show_edge=False,
        show_lines=False,
        box=None,
        padding=(0, 1),
        header_style=GRUVBOX["bg4"],
    )
    server_table.add_column("SERVER", min_width=12, style=GRUVBOX["fg"])
    server_table.add_column("PID", justify="right", min_width=6, style=GRUVBOX["fg"])
    server_table.add_column("PORT", justify="right", min_width=5, style=GRUVBOX["fg"])
    server_table.add_column("%CPU", justify="right", min_width=5, style=GRUVBOX["fg"])
    server_table.add_column("%MEM", justify="right", min_width=5, style=GRUVBOX["fg"])
    server_table.add_column("ELAPSED", justify="right", min_width=9, style=GRUVBOX["fg"])
    server_table.add_column("CWD", style=GRUVBOX["aqua"])

    for s in servers:
        server_table.add_row(
            Text(s["cmd"], style=GRUVBOX["red"]),
            s["pid"], s["port"], s["cpu"], s["mem"], s["elapsed"], s["cwd"],
        )
    if not servers:
        server_table.add_row(
            Text("(no dev servers running)", style=GRUVBOX["dim"]),
            "", "", "", "", "", "",
        )

    footer = Text()
    stray_count_style = GRUVBOX["yellow"] if strays else GRUVBOX["green"]
    footer.append(str(len(agents)), style=GRUVBOX["green"])
    footer.append(" agent(s), ", style=GRUVBOX["dim"])
    footer.append(str(len(servers)), style=GRUVBOX["green"])
    footer.append(" server(s), ", style=GRUVBOX["dim"])
    footer.append(str(len(strays)), style=stray_count_style)
    footer.append(" stray(s)", style=GRUVBOX["dim"])
    footer.append("  \u2022  q or ctrl-c to quit", style=GRUVBOX["dim"])

    return Group(header, agent_table, Text(), stray_table, Text(), server_table, Text(), footer)


def main() -> None:
    if len(sys.argv) > 1 and sys.argv[1] in ("-h", "--help"):
        print("Usage: lsagents")
        print()
        print("Monitor running AI coding agents and dev servers.")
        sys.exit(0)

    console = Console()

    if not sys.stdin.isatty():
        console.print(build_display())
        return

    fd = sys.stdin.fileno()
    old_settings = termios.tcgetattr(fd)

    try:
        tty.setcbreak(fd)
        with Live(
            build_display(),
            console=console,
            auto_refresh=False,
            screen=True,
        ) as live:
            while True:
                live.update(build_display())
                live.refresh()
                ready, _, _ = select.select([sys.stdin], [], [], 10)
                if ready:
                    key = sys.stdin.read(1)
                    if key in ("q", "\x03"):
                        break
    except KeyboardInterrupt:
        pass
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)


if __name__ == "__main__":
    main()
