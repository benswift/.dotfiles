#!/usr/bin/env bash
#
# Dotfiles management command
# Usage: dotfiles <command>
#
set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

pass=0
fail=0
warn=0

check_pass() { echo -e "  ${GREEN}✓${NC} $1"; ((pass++)) || true; }
check_fail() { echo -e "  ${RED}✗${NC} $1"; ((fail++)) || true; }
check_warn() { echo -e "  ${YELLOW}⚠${NC} $1 ${CYAN}(optional)${NC}"; ((warn++)) || true; }
section() { echo -e "\n${CYAN}$1${NC}"; }

command_exists() { command -v "$1" &>/dev/null; }

symlink_valid() {
    local target="$1"
    [[ -L "$target" && -e "$target" ]]
}

check_core() {
    section "Checking core requirements..."

    # Shell
    if [[ "$SHELL" == *zsh ]]; then
        check_pass "zsh is current shell"
    else
        check_fail "zsh is not current shell (using $SHELL)"
    fi

    # Homebrew (macOS only)
    if [[ "$OSTYPE" == darwin* ]]; then
        if command_exists brew; then
            local brew_prefix
            brew_prefix=$(brew --prefix)
            check_pass "Homebrew installed at $brew_prefix"
        else
            check_fail "Homebrew not installed"
        fi
    fi

    # mise
    if command_exists mise; then
        check_pass "mise installed"
    else
        check_fail "mise not installed"
    fi

    # jj
    if command_exists jj; then
        local jj_name jj_email
        jj_name=$(jj config get user.name 2>/dev/null || echo "")
        jj_email=$(jj config get user.email 2>/dev/null || echo "")
        if [[ -n "$jj_name" && -n "$jj_email" ]]; then
            check_pass "jj configured ($jj_name <$jj_email>)"
        else
            check_warn "jj installed but not configured"
        fi
    else
        check_fail "jj not installed"
    fi

    # git (needed for colocated repos and gh CLI)
    if command_exists git; then
        check_pass "git installed"
    else
        check_warn "git not installed"
    fi

    # zoxide
    if command_exists zoxide; then
        check_pass "zoxide installed"
    else
        check_fail "zoxide not installed"
    fi
}

check_symlinks() {
    section "Checking symlinks..."

    local symlinks=(
        "$HOME/.zshrc:$DOTFILES_DIR/zshrc"
        "$HOME/.zshenv:$DOTFILES_DIR/zshenv"
        "$HOME/.gitconfig:$DOTFILES_DIR/gitconfig"
        "$HOME/.gitignore:$DOTFILES_DIR/gitignore"
        "$HOME/.tmux.conf:$DOTFILES_DIR/tmux.conf"
        "$HOME/.config/mise/config.toml:$DOTFILES_DIR/mise/config.toml"
        "$HOME/.claude/CLAUDE.md:$DOTFILES_DIR/GLOBAL-AGENTS.md"
        "$HOME/.claude/settings.json:$DOTFILES_DIR/claude/settings.json"
        "$HOME/.codex/instructions.md:$DOTFILES_DIR/GLOBAL-AGENTS.md"
    )

    for entry in "${symlinks[@]}"; do
        local target="${entry%%:*}"
        local expected="${entry##*:}"

        if [[ -L "$target" ]]; then
            local actual
            actual=$(readlink "$target")
            if [[ "$actual" == "$expected" ]]; then
                check_pass "$(basename "$target") → $(basename "$expected")"
            else
                check_fail "$(basename "$target") points to wrong target"
            fi
        elif [[ -e "$target" ]]; then
            check_fail "$(basename "$target") exists but is not a symlink"
        else
            check_fail "$(basename "$target") missing"
        fi
    done
}

check_tools() {
    section "Checking tools..."

    local required_tools=(helix:hx tmux)
    local optional_tools=(neomutt mu mbsync msmtp rclone fzf)

    for tool in "${required_tools[@]}"; do
        local name="${tool%%:*}"
        local cmd="${tool##*:}"
        if command_exists "$cmd"; then
            check_pass "$name"
        else
            check_fail "$name not installed"
        fi
    done

    for tool in "${optional_tools[@]}"; do
        if command_exists "$tool"; then
            check_pass "$tool"
        else
            check_warn "$tool not installed"
        fi
    done
}

check_mise_tools() {
    section "Checking mise-managed tools..."

    if ! command_exists mise; then
        check_fail "mise not available, skipping tool check"
        return
    fi

    local tools
    tools=$(mise list --current 2>/dev/null | awk '{print $1}' | sort -u || echo "")

    if [[ -z "$tools" ]]; then
        check_warn "no mise tools installed (run 'mise install')"
    else
        for tool in $tools; do
            check_pass "$tool"
        done
    fi
}

check_directories() {
    section "Checking directories..."

    local dirs=(
        "$HOME/.config/zed"
        "$HOME/.config/mise"
        "$HOME/.claude"
        "$HOME/.codex"
    )

    local optional_dirs=(
        "$HOME/Maildir"
        "$HOME/.config/neomutt"
        "$HOME/.config/ghostty"
    )

    for dir in "${dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            check_pass "$(basename "$dir")/"
        else
            check_fail "$(basename "$dir")/ missing"
        fi
    done

    for dir in "${optional_dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            check_pass "$(basename "$dir")/"
        else
            check_warn "$(basename "$dir")/ missing"
        fi
    done
}

doctor() {
    echo ""
    echo "╔═══════════════════════════════════════╗"
    echo "║         Dotfiles Doctor               ║"
    echo "╚═══════════════════════════════════════╝"

    check_core
    check_symlinks
    check_tools
    check_mise_tools
    check_directories

    echo ""
    section "Summary"
    echo -e "  ${GREEN}$pass passed${NC}, ${RED}$fail failed${NC}, ${YELLOW}$warn warnings${NC}"
    echo ""

    if [[ $fail -gt 0 ]]; then
        echo "Run '$DOTFILES_DIR/create_symlinks.sh' to fix symlinks"
        echo "Run '$DOTFILES_DIR/install.sh' for full setup"
        return 1
    fi
}

update() {
    echo "Updating dotfiles..."
    if [[ -d "$DOTFILES_DIR/.jj" ]] && command_exists jj; then
        jj -R "$DOTFILES_DIR" git fetch
        jj -R "$DOTFILES_DIR" rebase -d main@origin
    else
        git -C "$DOTFILES_DIR" pull --rebase
    fi
    "$DOTFILES_DIR/create_symlinks.sh"
    echo "Done!"
}

usage() {
    echo "Usage: dotfiles <command>"
    echo ""
    echo "Commands:"
    echo "  doctor    Check if everything is set up correctly"
    echo "  update    Pull latest changes and re-run symlinks"
    echo "  edit      Open dotfiles in editor"
    echo "  cd        Print dotfiles directory (use: cd \$(dotfiles cd))"
    echo ""
}

case "${1:-}" in
    doctor) doctor ;;
    update) update ;;
    edit)   "${EDITOR:-hx}" "$DOTFILES_DIR" ;;
    cd)     echo "$DOTFILES_DIR" ;;
    *)      usage ;;
esac
