# Core settings
set realname = "Ben Swift"
set mbox_type = Maildir
set folder = ~/Maildir/
set header_cache = ~/.cache/neomutt/headers
set header_cache_backend = "lmdb"
set message_cachedir = ~/.cache/neomutt/messages
set confirmappend = no
set confirmcreate = yes
set delete_untag = yes
set tmpdir = ~/.cache/neomutt/temp
set save_history = 100
set history = 1000
set change_folder_next = yes
set mark_macro_prefix = "'"
set reverse_alias = yes
set simple_search = "~f %s | ~t %s | ~c %s | ~s %s"

# Editor
set editor = "zed-preview --wait"
set edit_headers = yes

# Compose
set compose_format = "-- NeoMutt: Compose [Approx. msg size: %l | Atts: %a]%>-"
set attribution = "On %{%a, %d %b %Y at %I:%M %p %Z}, %n wrote:"
set quote_regex = "^([ \t]*[|>:}#])+"
set reply_regex = "^(re:[ \t]*)+"

# Behaviour
set wait_key = no
set quit = ask-yes
set delete = yes
set move = no
set mark_old = no
set beep_new = yes
set pipe_decode = yes
set thorough_search = yes
set sleep_time = 0
set mail_check = 60
set read_inc = 100
set write_inc = 100
set net_inc = 5

# Address lookup
set query_command = "( mu cfind --format=mutt-ab '%s' 2>/dev/null )"
set query_format = "%3c %t %-25.25n %-25.25a %?e?(%e)?"

# Display
set sort = threads
set sort_aux = reverse-last-date-received
set sort_re = yes
set strict_threads = no
set hide_thread_subject = yes
set narrow_tree = yes
set pager_index_lines = 10
set pager_context = 3
set pager_stop = yes
set pager_read_delay = 0
set pager_format = "-%Z- %C/%m: %.20n   %s %* -- (%P)"
set menu_scroll = yes
set smart_wrap = yes
set tilde = yes
set markers = no
set date_format = "%d/%m/%y %H:%M"
set index_format = "%4C %Z %?X?A& ? %{%b %d} %-15.15L %?M?(#%03M)&(%4l)? %s"
set mail_check_stats = yes
set mail_check_stats_interval = 60
set display_filter = "sed 's/\x1b\[[0-9;]*[mGKHF]//g'"

# Sidebar
set sidebar_visible = yes
set sidebar_width = 25
set sidebar_format = "%D%?F? [%F]?%* %?N?%N/?%S"
set sidebar_short_path = yes
set sidebar_delim_chars = "/"
set sidebar_folder_indent = no
set sidebar_indent_string = "  "
set sidebar_new_mail_only = no
set sidebar_sort_method = "unsorted"
set sidebar_component_depth = 1

# Key bindings for sidebar
bind index,pager K sidebar-prev
bind index,pager J sidebar-next
bind index,pager L sidebar-open
bind index,pager H sidebar-toggle-visible

# Mailboxes with named labels
# Define these BEFORE sourcing account configs that change folder
unmailboxes *
named-mailboxes "Personal" =personal/INBOX
named-mailboxes "  Archive" =personal/Archive
named-mailboxes "  Drafts" =personal/Drafts
named-mailboxes "  Sent" =personal/"Sent Items"
named-mailboxes "  Trash" =personal/Trash
named-mailboxes "ANU" =anu/INBOX
named-mailboxes "  Archive" =anu/Archive
named-mailboxes "  Drafts" =anu/Drafts
named-mailboxes "  Sent" =anu/"Sent Items"
named-mailboxes "  Deleted" =anu/"Deleted Items"
named-mailboxes "PhD Convenor" =phdconvenor/INBOX
named-mailboxes "  Archive" =phdconvenor/Archive
named-mailboxes "  Drafts" =phdconvenor/Drafts
named-mailboxes "  Sent" =phdconvenor/"Sent Items"
named-mailboxes "  Deleted" =phdconvenor/"Deleted Items"

# Load vombatidae color theme first
source ~/.config/neomutt/vombatidae.mutt

# Account switching - source after mailboxes are defined
source ~/.config/neomutt/accounts/personal
folder-hook personal/* source ~/.config/neomutt/accounts/personal
folder-hook anu/* source ~/.config/neomutt/accounts/anu
folder-hook phdconvenor/* source ~/.config/neomutt/accounts/phdconvenor

# Search bindings (vim-style)
macro index / "<shell-escape>mu find --clearlinks --format=links --linksdir=~/.mu/results " "mu find"
macro index ? "<search-reverse>" "search backwards"
macro index n "<search-next>" "next search result"
macro index N "<search-opposite>" "previous search result"
macro index ,r "<change-folder-readonly>~/.mu/results<enter>" "mu results"
macro index,pager ,u "<shell-escape>mu find --clearlinks --format=links --linksdir=~/.mu/results flag:unread<enter><change-folder-readonly>~/.mu/results<enter>" "show unread"

# Unread management
macro index ,m "<tag-pattern>~U<enter><tag-prefix><clear-flag>N<untag-pattern>~T<enter>" "mark all as read"
macro index U "<toggle-new>" "toggle unread status"

# Sync bindings
bind index x sync-mailbox
macro index ,s "<shell-escape>mailsync<enter>" "sync all mail"
macro index ,S "<shell-escape>mbsync -a<enter>" "sync mail (no index)"

# Account switching macros
macro index,pager ,p '<sync-mailbox><enter-command>source ~/.config/neomutt/accounts/personal<enter><change-folder>!<enter>'
macro index,pager ,a '<sync-mailbox><enter-command>source ~/.config/neomutt/accounts/anu<enter><change-folder>!<enter>'
macro index,pager ,c '<sync-mailbox><enter-command>source ~/.config/neomutt/accounts/phdconvenor<enter><change-folder>!<enter>'

# Threading
set collapse_unread = no
set uncollapse_jump = yes
bind index za collapse-thread
bind index zA collapse-all

# Vim-style navigation
bind pager g noop
bind pager gg top
bind pager G bottom
bind index g noop
bind index gg first-entry
bind index G last-entry
bind index,pager \Cd half-down
bind index,pager \Cu half-up
bind pager \Cj next-line
bind pager \Ck previous-line

# Quick folder navigation
macro index gi '<change-folder>=INBOX<enter>' "go to inbox"
macro index ga '<change-folder>=Archive<enter>' "go to archive"
macro index gs '<change-folder>=Sent<enter>' "go to sent"
macro index gd '<change-folder>=Drafts<enter>' "go to drafts"

# Archive workflow
macro index,pager a "<save-message>=Archive<enter>" "archive message"
macro index,pager A "<tag-thread><tag-prefix><save-message>=Archive<enter>" "archive thread"
macro index,pager e "<save-message>=Archive<enter><sync-mailbox>" "archive and sync"
macro pager d "<exit><save-message>=Archive<enter>" "archive from pager"

# Attachments
set attach_format = "[%D %t] %2n [%-7.7m/%10.10M] %.40d %> [%s] "
alternative_order text/plain text/html
auto_view text/html
set implicit_autoview = yes
set abort_noattach = ask-yes
set abort_noattach_regex = "\\<(attach|attached|attachments?|^attached|^attachment|(see|check) (attachments?|attached))\\>"
set forward_attachments = yes
set mime_forward = ask-no
set attach_save_dir = "~/Downloads"

# GPG/encryption (optional)
set crypt_use_gpgme = no
set crypt_autosign = no
set crypt_opportunistic_encrypt = no

# === Additional Quality-of-Life Settings ===

# URL handling
macro index,pager \cb "<pipe-message> urlscan<enter>" "call urlscan to extract URLs"
macro attach,compose \cb "<pipe-entry> urlscan<enter>" "call urlscan to extract URLs"

# Message tagging shortcuts
bind index <space> tag-entry
bind index <Esc><space> tag-thread
bind index <Esc>t tag-pattern
macro index \Ca "<tag-pattern>~A<enter>" "tag all messages"
macro index \Cn "<untag-pattern>~T<enter>" "untag all messages"

# Better deletion workflow
bind index,pager d noop
macro index,pager dd "<delete-message><sync-mailbox>" "move to trash"
macro index,pager dat "<delete-thread><sync-mailbox>" "delete thread"

# Quick limit (filter) shortcuts
macro index \Cl "<limit>all<enter>" "remove limit"
macro index ,u "<limit>~U<enter>" "limit to unread"
macro index ,t "<limit>~d <1w<enter>" "limit to this week"
macro index ,y "<limit>~d <1d<enter>" "limit to today"
macro index ,f "<limit>~F<enter>" "limit to flagged"

# Additional folder navigation
macro index,pager gt "<change-folder>=" "go to folder root"
bind index M noop
macro index,pager Mi "<change-folder>=INBOX<enter>" "go to inbox"
macro index,pager Ms "<change-folder>=Sent<enter>" "go to sent"
macro index,pager Md "<change-folder>=Drafts<enter>" "go to drafts"
macro index,pager Ma "<change-folder>=Archive<enter>" "go to archive"
